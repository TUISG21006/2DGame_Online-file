<!DOCTYPE html>
<html>
<head>
<title>テスト</title>
</head>
<canvas id="view" width = "720px" height = "480px"></canvas>
<script src="socket.io/socket.io.js"></script>
<body>
<script type="text/javascript">
//サーバとの接続
var socket = io.connect();
//ドキュメント要素の取得
var canvas = document.getElementById('view');
//canvasに描画するコンテキストを取得
var ctx = canvas.getContext('2d');

let map,number,inits;
let block_size,item_size,limit_time,keycode_up,keycode_do,keycode_le,keycode_ri,up_flag,do_flag,le_flag,ri_flag;
let ava = [];
let item_list = [];
let flag = {
    up:false,
    down:false,
    left:false,
    right:false
}
socket.emit('room_join');

socket.on('join',(num,mapData,avaterData,initData)=>{
    number = num;
    map = mapData.map;
    console.log(map);
    ava = avaterData;
    inits = initData;
    init();
    setInterval(()=>{
        move(number)
    },1000/inits.max_move);
    setInterval(()=>{
        drow();
    },1000/60);
});

socket.on('Server to Client',(User,item,time)=>{
    ava = User;
    item_list = item;
    limit_time = time;
});

//サーバから送られた情報での初期設定
const init = function(){
    console.log("init");

    item_size = inits.item_size;
    block_size = inits.block_size;
    keycode_up = inits.keycode_up;
    keycode_do = inits.keycode_do;
    keycode_le = inits.keycode_le;
    keycode_ri = inits.keycode_ri;
    chara_set(0,inits.sizew,inits.sizeh,inits.user_setx,inits.user_sety);
}

//キーボード操作関数
document.onkeydown = function (e) {
    if(e.key == keycode_up)flag.up = true;
    if(e.key == keycode_do)flag.down = true;
    if(e.key == keycode_le)flag.left = true;
    if(e.key == keycode_ri)flag.right = true;
}
document.onkeyup = function(e){
    if(e.key == keycode_up)flag.up = false;
    if(e.key == keycode_do)flag.down = false;
    if(e.key == keycode_le)flag.left = false;
    if(e.key == keycode_ri)flag.right = false;
}

let move = function(num){
    socket.emit("Client to Server",number,flag);
}

//自キャラ作画用変数
let chara;
let other_chara;
let avater_list = [];

//自キャラ登録用関数（アバタの画像、サイズ横、サイズ縦、初期位置x、初期位置y）
//登録後は「chara(座標x,座標y)」でアバタを描画
let chara_set = function(type = 0,wide = 10,hight = 10,x = 0,y = 0){
    if(type == 0){
        chara = function(x,y,angle,acsell = 0){
            ctx.save();
            ctx.translate(x + wide / 2, y + hight / 2);
            ctx.rotate(angle);
            ctx.translate(-x - wide / 2,-y - hight / 2);
            ctx.font = acsell*wide/3+"px serif";
            ctx.fillText("↑", x + wide/2 - acsell*5,y);
            ctx.strokeRect(x,y,wide,hight);
            ctx.restore();
        }
    }
    else{
        chara = function(x,y,angle){
            ctx.save();
            ctx.translate(x + wide / 2, y + hight / 2);
            ctx.rotate(angle);
            ctx.translate(-x - wide / 2,-y - hight / 2);
            ctx.drawImage(type,x,y,wide,hight)
            ctx.restore();
        }
    }
}

//画面描画用関数（流用性はかなり低い:変数ava_x,ava_y,angle）
let drow = function(){
    //画面削除
    ctx.clearRect(0, 0,800,480);
    ctx.beginPath();

    ctx.fillStyle = "#000000";
    ctx.fillText(limit_time,500,200);
    //自アバタ描画
    //chara(ava_x,ava_y,angle1);
    

    //アバタ描画
    for(var i = 0;i < ava.length;i++){
        console.log(ava[i]);
        if(ava[i] != undefined){
            
            //ctx.fillRect(ava[i].x,ava[i].y,inits.sizeh,inits.sizeh);
            chara(ava[i].x,ava[i].y,ava[i].angle);
        }
    }

    //ステージブロックの描画
    for(var i = 0;i < map.length;i++){
        for(let j = 0;j < map[i].length;j++){
            if(map[i][j] == 1)
            ctx.fillRect(j*block_size,i*block_size,block_size,block_size);
        }
    }

    //アイテムオブジェクトの描画
    ctx.fillStyle = "#FFA500";
    for(var j = 0;j<item_list.length;j++){
        if(item_list[j].get == false){
            ctx.fillRect(item_list[j].x,item_list[j].y,item_size,item_size);
        }
    }
}
socket.on("Gaame End",function(num,score){
    if(num == number){
        alert("YOU WIN");
    }
    else{
        alert("YOU LOSE");
    }
});
let main = function(){
    
}
</script>
</body>
</html>