<!DOCTYPE html>
<html>
<head>
<title>テスト</title>
</head>
<canvas id="view" width = "720px" height = "480px"></canvas>
<script src="socket.io/socket.io.js"></script>
<script src="Collision.js"></script>
<script src="MainFunc.js"></script>
<script src="MoveFunc.js"></script>
<script src="SocketFunc.js"></script>
<body>
<script type="text/javascript">
//ドキュメント要素の取得
var canvas = document.getElementById('view');
//canvasに描画するコンテキストを取得
var ctx = canvas.getContext('2d');

let AvaterData = [];
let Time;
let ItemData = [];
let My_num,Init,Map;
let AttackData = [];
let AttackMoveList = [];

let chara,WideCenter,HightCenter;

//if文のマジナン対策(同期箇所判定)
let Client = false;
let Server = true;

//入室処理（Data:アバター配列）
socket.on('Enter',(Data,map,init,item)=>{
    AvaterData = Data;          //ユーザ情報の読み込み
    Map = map;                  //地形情報の読み込み
    Init = init;                //基本設定の読み込み
    My_num = Data.length - 1;   //操作番号の割り当て
    ItemData = item;            //アイテムデータの読み込み
    chara = chara_set(Init);    //アバタ描画処理の読み込み
    Time = Init.limit_time;

    //================[TEST SPACE]======================
    AtacSpeed = 3;
    //==================================================

    //メインで行う処理
    let main = setInterval (()=>{
        for(var i = 0;i < ItemData.length;i++){
            if(item_collision(AvaterData[My_num],ItemData[i],Init.item_size,Init.item_size)){
                ItemGet(My_num,i);
            }
        }

        //攻撃オブジェクトとの接触判定
        for(var i = 0;i < AttackData.length;i++){
            if(item_collision(AvaterData[My_num],AttackData[i],Init.bullet_size,Init.bullet_size)){
                if(AvaterData[My_num].id != AttackData[i].id){
                    if(AvaterData[My_num].hp > 0)AvaterData[My_num].hp--;

                    console.log(AvaterData[My_num].hp);
                    AttackData.splice(i,1);
                    socket.emit('AttackData_splice',i,My_num);
                }

            }
        }

        //ゲーム終了時の処理(Intervalのclearがメイン)
        if(AvaterData[My_num].hp <= 0||Time <= 0){
            GameOver();
            clearInterval(main)
            clearInterval(BasicProcess)
            clearInterval(AttackMove)
        }

        //時間の進行(改修予定)
        Time -= 1/Init.fps;
        if(Time<0)Time = 0;
    },1000/Init.fps);

    //簡易実装番攻撃処理
    let AttackMove = setInterval(()=>{
        for (let index = 0; index < AttackData.length; index++){
            AttackMoveList[0](index);
        }
    },1000/Init.fps)

    //描画と操作処理（サーバ同期の際は受信時に行う）
    let BasicProcess = setInterval (()=>{
        //サーバ同期の場合クライアントの権限で実行しない
        if(Init.Synchro_Avatar == Server)clearInterval(BasicProcess);

        //操作処理
        AvaterData[My_num] = move(AvaterData[My_num],Init.Genre);
        //描画処理
        drow(Map,AvaterData,ItemData,AttackData,Init);
    },1000/Init.fps);

});





























//ゲーム終了時の表示関数
let GameOver = function(){
    alert(AvaterData[My_num].score)
}



//オブジェクトとアバタが重時の動作(ava:My_num , num:取得したアイテム)
let ItemGet = function(ava,num){
    //ここにコードを追加（例：未取得のアイテムを取得しスコアを加算）
    if(!ItemData[num].get) {
        if(Init.Synchro_Item == Client){
            AvaterData[My_num].score++;
            ItemData[num].get = true;
        }
        socket.emit('Synchronize_Item',num);
    }
}
































//=====================[試作の攻撃関数]=======================

let AttackAdd = function(id,x,y,angle)
{
    this.id = id;
    this.x = x;
    this.y = y;
    this.angle = angle;
    this.time = 0;
    this.move = 3
}

//周囲回転型の近接攻撃
AttackMoveList.push(function(num){
    AttackData[num].y = AvaterData[AvaterData.findIndex((e) => e.id === AttackData[num].id)].y + Init.sizew/2
    AttackData[num].x = AvaterData[AvaterData.findIndex((e) => e.id === AttackData[num].id)].x + Init.sizeh/2
    AttackData[num].y -= 50 * Math.cos(AttackData[num].angle);
    AttackData[num].x += 50 * Math.sin(AttackData[num].angle); 
    AttackData[num].angle += 0.1;
}) 

//直線進行型の遠距離攻撃
AttackMoveList.push(function(num){
    AttackData[num].y -= 1 * Math.cos(AttackData[num].angle);
    AttackData[num].x += 1 * Math.sin(AttackData[num].angle);
}) 
</script>
</body>
</html>